<!DOCTYPE html>
<script>

var msgCount = 0;
var hasSession = 0;

safari.application.addEventListener("validate", performValidation, false);
safari.application.addEventListener("command", performAction, false);
safari.application.addEventListener("message", handleMessage, false);

function performValidation(event)
{
	switch(event.command) {
		case "displayMessages":
			if("badge" in event.target) {
				event.target.badge = msgCount;
				event.target.toolTip = "GRDB" + (hasSession?" ("+msgCount+")":"");
			}
		break;
	}
}

function performAction(event)
{
	switch(event.command) {
		case "displayMessages":
			var protocol = safari.extension.settings.getItem("ssl")?"https":"http";
			var site = safari.extension.settings.getItem("site");
			var url;
			if(hasSession) {
				url = protocol+"://"+site+"/mitglieder/messages/uebersicht.php?suche=neue";
			} else {
				msgCount = 0;
				validateToolbarItems();
				url = protocol+"://"+site+"/";
			}
			activateTabWithURL(url);
		break;
	}
}

function handleMessage(message)
{
	switch(message.name) {
		case "messageCountDidChange":
			hasSession = 1;
			msgCount = message.message;
			validateToolbarItems();
		break;
		case "sessionDidEnd":
			hasSession = 0;
			msgCount = 0;
			validateToolbarItems();
		break;
	}
}

function validateToolbarItems()
{
	var items = safari.extension.toolbarItems;
	for(var i=0; i<items.length; i++) {
		if(items[i].command==="displayMessages") {
			items[i].validate();
		}
	}
}

function activateTabWithURL(url)
{
	var theTab;

	for(windowIndex in safari.application.browserWindows) {
		for(tabIndex in safari.application.browserWindows[windowIndex].tabs) {
			theTab = safari.application.browserWindows[windowIndex].tabs[tabIndex];
			if((theTab.url && theTab.url.indexOf(url)!=-1) || theTab.url=="") {
				theTab.browserWindow.activate();
				theTab.activate();
				if(!theTab.url || theTab.url!=url) {
					theTab.url = url;
				}
				return theTab;
			}
		}
	}

	if(!safari.application.activeBrowserWindow) {
		safari.application.openBrowserWindow();
	}
	theTab = safari.application.activeBrowserWindow.openTab();
	theTab.url = url;
	return theTab;
}

</script>
