<!DOCTYPE html>
<script>

var base = safari.extension.settings["protocol"] + "://" + safari.extension.settings["site"];
var msgCount = 0;
var hasSession = false;

safari.application.addEventListener("validate", performValidation, false);
safari.application.addEventListener("command", performAction, false);
safari.application.addEventListener("message", handleMessage, false);
safari.extension.settings.addEventListener("change", handleSettingsChange, false);

function performValidation(event)
{
	switch(event.command) {
		case "displayMenu":
			if("badge" in event.target) {
				event.target.badge = msgCount;
				event.target.toolTip = "GRDB" + (hasSession?" ("+msgCount+")":"");
			}
		break;
	}
}

function performAction(event)
{
	switch(event.command) {
		case "displayMenu":
			if(hasSession) {
				var menuTab = activateTabWithURL(safari.extension.baseURI + "grdb.html");
				menuTab.page.dispatchMessage("fetch", base);
			} else {
				activateTabWithURL(base+"/");
			}
		break;
	}
}

function handleMessage(message)
{
	switch(message.name) {
		case "messageCountDidChange":
			hasSession = true;
			msgCount = message.message;
			validateToolbarItems();
		break;
		case "sessionDidEnd":
			hasSession = false;
			msgCount = 0;
			validateToolbarItems();
		break;
		case "retrieveBase":
			message.target.page.dispatchMessage("fetch", base);
		break;
	}
}

function handleSettingsChange(change)
{
	base = safari.extension.settings["protocol"] + "://" + safari.extension.settings["site"];
}

function validateToolbarItems()
{
	var items = safari.extension.toolbarItems;
	for(var i=0; i<items.length; i++) {
		if(items[i].command==="displayMenu") {
			items[i].validate();
		}
	}
}

function activateTabWithURL(url)
{
	var theTab;

	for(windowIndex in safari.application.browserWindows) {
		for(tabIndex in safari.application.browserWindows[windowIndex].tabs) {
			theTab = safari.application.browserWindows[windowIndex].tabs[tabIndex];
			if((theTab.url && theTab.url.indexOf(url)!=-1) || theTab.url=="") {
				theTab.browserWindow.activate();
				theTab.activate();
				if(!theTab.url || theTab.url!=url) {
					theTab.url = url;
				}
				return theTab;
			}
		}
	}

	if(!safari.application.activeBrowserWindow) {
		safari.application.openBrowserWindow();
	}
	theTab = safari.application.activeBrowserWindow.openTab();
	theTab.url = url;
	return theTab;
}

</script>
