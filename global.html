<!DOCTYPE html>
<script>

var base = safari.extension.settings["protocol"] + "://" + safari.extension.settings["site"];
var msgCount = 0;
var userCount = 0;
var visitorCount = 0;
var hasSession = false;
var readyFunc;


safari.application.addEventListener("validate", function(event) {
	switch(event.command) {
		case "displayMenu":
			if("badge" in event.target) {
				event.target.badge = msgCount;
				event.target.toolTip = "GRDB" + (hasSession?" ("+msgCount+")":"");
			}
		break;
	}
}, false);

safari.application.addEventListener("command", function(event) {
	switch(event.command) {
		case "displayMenu":
			showMails();
		break;
	}
}, false);

safari.application.addEventListener("popover", function(event) {
	switch(event.target.identifier) {
		case "GRDBPopover":
			event.target.contentWindow.displayCounts(msgCount, userCount, visitorCount);
		break;
	}
}, false);

safari.application.addEventListener("message", function(message) {
	switch(message.name) {
		case "messageCountDidChange":
			hasSession = true;
			msgCount = message.message;
			validateToolbarItems();
		break;
		case "userCountDidChange":
			hasSession = true;
			userCount = message.message;
		break;
		case "visitorCountDidChange":
			hasSession = true;
			visitorCount = message.message;
		break;
		case "sessionDidEnd":
			hasSession = false;
			msgCount = 0;
			userCount = 0;
			visitorCount = 0;
			validateToolbarItems();
		break;
		case "openBase":
			activateTabWithURL(base+"/");
		break;
		case "ready":
			if(readyFunc) {
				readyFunc(message.target);
			}
		break;
		case "findUser":
			performUserSearch(message.message);
		break;
	}
}, false);

safari.extension.settings.addEventListener("change", function(event) {
	base = safari.extension.settings["protocol"] + "://" + safari.extension.settings["site"];
}, false);

function showMails()
{
	if(!hasSession) {
		activateTabWithURL(base+"/");
		return;
	}
	activateTabWithURL(safari.extension.baseURI + "grdb.html", function (tab) {
		tab.page.dispatchMessage("fetchMails", base);
	});
	hidePopover("GRDBPopover");
}

function showVisitors()
{
	if(!hasSession) {
		activateTabWithURL(base+"/");
		return;
	}
	activateTabWithURL(safari.extension.baseURI + "grdb.html", function (tab) {
		tab.page.dispatchMessage("fetchVisitors", base);
	});
	hidePopover("GRDBPopover");
}

function hidePopover(name)
{
	var popovers = safari.extension.popovers;
	for(var i=0; i<popovers.length; i++) {
		if(popovers[i].identifier==name) {
			popovers[i].hide();
		}
	}
}

function performUserSearch(user)
{
	var id = parseInt(user);
	var url;
	if(id) {
		url = base+"/auswertung/setcard/index.php?set="+id;
	} else {
		url = base+"/search/index.php?action=execute&searchType=direct&directMode=userName&directValue="+user;
	}
	activateTabWithURL(url);
}

function validateToolbarItems()
{
	var items = safari.extension.toolbarItems;
	for(var i=0; i<items.length; i++) {
		if(items[i].command==="displayMenu") {
			items[i].validate();
		}
	}
}

function activateTabWithURL(url, aReadyFunc)
{
	var theTab;
	readyFunc = null;

	for(windowIndex in safari.application.browserWindows) {
		for(tabIndex in safari.application.browserWindows[windowIndex].tabs) {
			theTab = safari.application.browserWindows[windowIndex].tabs[tabIndex];
			if((theTab.url && theTab.url.indexOf(url)!=-1) || theTab.url=="") {
				theTab.browserWindow.activate();
				theTab.activate();
				if(!theTab.url || theTab.url!=url) {
					theTab.url = url;
					readyFunc = aReadyFunc;
				} else if(aReadyFunc) {
					aReadyFunc(theTab);
				}
				return theTab;
			}
		}
	}

	if(!safari.application.activeBrowserWindow) {
		safari.application.openBrowserWindow();
	}
	theTab = safari.application.activeBrowserWindow.openTab();
	theTab.url = url;
	readyFunc = aReadyFunc;
	return theTab;
}

</script>
