<!DOCTYPE html>
<script>

var base = safari.extension.settings["protocol"] + "://" + safari.extension.settings["site"];
var msgCount = 0;
var userCount = 0;
var visitorCount = 0;
var hasSession = false;
var panel = new Panel();


safari.application.addEventListener("validate", function(event) {
	switch(event.command) {
		case "displayMenu":
			if("badge" in event.target) {
				event.target.badge = msgCount;
				event.target.toolTip = "GRDB" + (hasSession?" ("+msgCount+")":"");
			}
		break;
	}
}, false);

safari.application.addEventListener("command", function(event) {
	switch(event.command) {
		case "displayMenu":
			showMails(true);
		break;
	}
}, false);

safari.application.addEventListener("popover", function(event) {
	switch(event.target.identifier) {
		case "GRDBPopover":
			event.target.contentWindow.displayCounts(hasSession, msgCount, userCount, visitorCount);
		break;
	}
}, false);

safari.application.addEventListener("message", function(message) {
	switch(message.name) {
		case "messageCountDidChange":
			hasSession = true;
			msgCount = message.message;
			validateToolbarItems();
		break;
		case "userCountDidChange":
			hasSession = true;
			userCount = message.message;
		break;
		case "visitorCountDidChange":
			hasSession = true;
			visitorCount = message.message;
		break;
		case "sessionDidEnd":
			hasSession = false;
			msgCount = 0;
			userCount = 0;
			visitorCount = 0;
			validateToolbarItems();
		break;
		case "openBase":
			activateTabWithURL(base+"/");
		break;
		case "findUser":
			performUserSearch(message.message);
		break;
		case "userSeen":
			panel.lenientMessage("userOnline", message.message);
		break;
	}
}, false);

safari.extension.settings.addEventListener("change", function(event) {
	base = safari.extension.settings["protocol"] + "://" + safari.extension.settings["site"];
}, false);

function openHome()
{
	hidePopover("GRDBPopover");
	activateTabWithURL(base+"/");
}

function showMails(main)
{
	if(main && !hasSession) {
		activateTabWithURL(base+"/");
		return;
	}
	showSection("fetchMails");
}

function showUsers()
{
	showSection("fetchUsers");
}

function showVisitors()
{
	showSection("fetchVisitors");
}

function showSection(section)
{
	hidePopover("GRDBPopover");
	panel.message(section, base);
}

function hidePopover(name)
{
	var popovers = safari.extension.popovers;
	for(var i=0; i<popovers.length; i++) {
		if(popovers[i].identifier==name) {
			popovers[i].hide();
		}
	}
}

function performUserSearch(user)
{
	var id = parseInt(user);
	var url;
	if(id) {
		url = base+"/auswertung/setcard/index.php?set="+id;
	} else {
		url = base+"/search/index.php?action=execute&searchType=direct&directMode=userName&directValue="+user;
	}
	activateTabWithURL(url);
}

function validateToolbarItems()
{
	var items = safari.extension.toolbarItems;
	for(var i=0; i<items.length; i++) {
		if(items[i].command==="displayMenu") {
			items[i].validate();
		}
	}
}

function activateTabWithURL(url)
{
	var theTab, emptyTab;

	for(windowIndex in safari.application.browserWindows) {
		for(tabIndex in safari.application.browserWindows[windowIndex].tabs) {
			theTab = safari.application.browserWindows[windowIndex].tabs[tabIndex];
			if(theTab.url && theTab.url.indexOf(url)!=-1) {
				theTab.browserWindow.activate();
				theTab.activate();
				if(theTab.url!=url) {
					theTab.url = url;
				}
				return theTab;
			} else if(theTab.url=="") {
				emptyTab = theTab;
			}
		}
	}

	if(emptyTab) {
		emptyTab.browserWindow.activate();
		emptyTab.activate();
		emptyTab.url = url;
		return emptyTab;
	}

	if(!safari.application.activeBrowserWindow) {
		safari.application.openBrowserWindow();
	}
	theTab = safari.application.activeBrowserWindow.openTab();
	theTab.url = url;
	return theTab;
}

function Panel() {
	var theTab=null;

	function makeTab(readyFunc) {
		theTab = activateTabWithURL(safari.extension.baseURI + "grdb.html");
		theTab.addEventListener("navigate", function() {
			readyFunc(theTab);
		}, false);
		theTab.addEventListener("close", function() {
			theTab = null;
		}, false);
	}

	this.isOpen = function () {
		return theTab!==null;
	}

	this.message = function (message, value) {
		messageFunc = function(tab) {
			tab.page.dispatchMessage(message, value);
		};
		if(theTab) {
			theTab.browserWindow.activate();
			theTab.activate();
			messageFunc(theTab);
		} else {
			makeTab(messageFunc);
		}
	}

	this.lenientMessage = function (message, value) {
		if(theTab) {
			theTab.page.dispatchMessage(message, value);
		}
	}
}

</script>
